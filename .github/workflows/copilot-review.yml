# ==============================================================================
# GitHub Copilot Code Review
# ==============================================================================
# Automated code review using GitHub Copilot:
# - Reviews code changes in pull requests
# - Provides AI-powered suggestions and feedback
# - Runs on PR open, sync, and reopen events
# ==============================================================================

name: "Copilot Code Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-review:
    name: Copilot Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Add a comment requesting Copilot review
            const comment = `### ðŸ¤– GitHub Copilot Review Requested

            @github-copilot please review this pull request for:
            - Code quality and best practices
            - Terraform/IaC specific issues
            - Security concerns
            - Potential improvements

            *This is an automated review request.*`;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('GitHub Copilot Review Requested')
            );

            if (!existingComment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
