# Landing Zone Subscription Placement

This directory contains configurations for placing Azure subscriptions into their respective management groups.

## Structure

```
landing-zones/
├── connectivity/           Platform - Connectivity subscription
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── identity/              Platform - Identity subscription
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── management/            Platform - Management subscription
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── workloads/             Workload landing zones
│   └── portals-dev/       Portal dev subscription
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── terraform.tfvars.example
└── README.md              This file
```

## Platform Landing Zones

### Connectivity
- **Management Group**: `acme-connectivity`
- **Subscription ID**: `c82e0943-3765-49ff-97ff-92855167f3ea`
- **Purpose**: Hub networking, VPN/ExpressRoute, firewalls
- **Deployment**: `cd connectivity && terraform apply`

### Identity
- **Management Group**: `acme-identity`
- **Subscription ID**: `05783002-9abe-4167-9270-694d4e9bb733`
- **Purpose**: Domain controllers, AD Connect, identity services
- **Deployment**: `cd identity && terraform apply`

### Management
- **Management Group**: `acme-management`
- **Subscription ID**: `1302f5fd-f3b5-4eda-909c-e3ae2dfee3d6`
- **Purpose**: Monitoring, backup, automation, governance tools
- **Deployment**: `cd management && terraform apply`

## Workload Landing Zones

### Portals Dev
- **Management Group**: `acme-portals`
- **Subscription ID**: `9a877ddf-9796-43a8-a557-f6af1df195bf`
- **Purpose**: Portal application development environment
- **Deployment**: `cd workloads/portals-dev && terraform apply`

## Quick Start

### Platform Subscriptions (Deploy First)

These place platform subscriptions into their respective management groups:

```bash
# Connectivity subscription
cd connectivity
terraform init -backend-config=../../00-bootstrap/backend-config-connectivity.txt
terraform apply

# Identity subscription
cd ../identity
terraform init -backend-config=../../00-bootstrap/backend-config-identity.txt
terraform apply

# Management subscription
cd ../management
terraform init -backend-config=../../00-bootstrap/backend-config-management.txt
terraform apply
```

### Workload Subscriptions (Deploy After Platform)

```bash
# Portal dev subscription
cd workloads/portals-dev
terraform init -backend-config=../../../00-bootstrap/backend-config-portal-dev.txt
terraform apply
```

## What Each Layer Creates

### Platform Landing Zones
Platform landing zones only create the subscription association:
- **Subscription Association**: Links subscription to appropriate management group
  - Inherits policies from ALZ foundation
  - Enables governance and compliance

### Workload Landing Zones
Workload landing zones (like portals-dev) create networking and monitoring infrastructure:

#### Networking Resources
- **Resource Group**: `acme-rg-{landing-zone}-{environment}-{region}-net`
- **Virtual Network**: `acme-vnet-{landing-zone}-{environment}-{region}-{unique}`
  - Hub connectivity for workload isolation
  - Subnets for web apps, private endpoints, and data services
  - Service endpoints and delegations as needed

#### Monitoring Resources
- **Resource Group**: `acme-rg-{landing-zone}-{environment}-{region}-mon`
- **Log Analytics Workspace**: `acme-log-{landing-zone}-{environment}-{region}-{unique}`
  - Configurable retention period (default 30 days)
  - Shared by all workloads in this environment

#### Subscription Association
- Links subscription to management group
- Inherits policies from ALZ foundation

## Example: Portal Dev Deployment

```bash
cd workloads/portals-dev
terraform init -backend-config=../../../00-bootstrap/backend-config-portal-dev.txt
terraform apply
```

This creates:
- `acme-rg-portals-dev-eus-net` - Networking resource group
- `acme-rg-portals-dev-eus-mon` - Monitoring resource group
- `acme-vnet-portals-dev-eus-{unique}` - Virtual network (10.200.0.0/16)
- `acme-log-portals-dev-eus-{unique}` - Log Analytics workspace

## Deployment Order

```
Step 1: 01-foundation/          → Creates management groups & policies
         ↓
Step 2: 02-landing-zones/       → Places subscriptions into management groups (THIS)
         ↓  
Step 3: 03-workloads/           → Deploys application resources
```

## Backend Configuration

Each landing zone uses a separate Terraform state container generated by `00-bootstrap`:

- **connectivity**: `backend-config-connectivity.txt` → `tfstate-connectivity` container
- **identity**: `backend-config-identity.txt` → `tfstate-identity` container
- **management**: `backend-config-management.txt` → `tfstate-management` container
- **portals-dev**: `backend-config-portal-dev.txt` → `tfstate-portal-dev` container

## Verification

After deployment, verify subscriptions are in the correct management groups:

```powershell
# Check connectivity subscription
az account management-group show --name acme-connectivity

# Check identity subscription
az account management-group show --name acme-identity

# Check management subscription
az account management-group show --name acme-management

# Check portals dev subscription
az account management-group show --name acme-portals
```

## Notes

- Platform subscriptions (connectivity, identity, management) only create subscription associations
- Workload subscriptions (portals-dev) also create Log Analytics workspace for monitoring
- All subscription IDs are set as defaults in `variables.tf` files
- Only `tenant_id` needs to be provided in `terraform.tfvars`

## Creating Additional Landing Zones

To create a new workload landing zone:

1. **Copy an existing landing zone** as a template:
   ```bash
   cp -r workloads/portals-dev workloads/my-new-app
   ```

2. **Update the configuration** in `terraform.tfvars`:
   ```hcl
   landing_zone_name = "my-new-app"
   environment       = "dev"  # or "prod"
   subscription_id   = "your-subscription-id"
   ```

3. **Update naming suffix** in `main.tf`:
   ```hcl
   module "naming" {
     source   = "../../../shared-modules/naming"
     location = var.location
     suffix   = ["myapp", var.environment]  # Change "myapp" to your identifier
   }
   ```

4. **Deploy**:
   ```bash
   cd workloads/my-new-app
   terraform init -backend-config=../../../00-bootstrap/backend-config-my-new-app.txt
   terraform apply
   ```

## Outputs

Each landing zone provides outputs for connecting workloads:

```bash
# Networking outputs
terraform output networking_resource_group_name
terraform output virtual_network_name
terraform output virtual_network_id
terraform output subnets

# Monitoring outputs
terraform output monitoring_resource_group_name
terraform output log_analytics_workspace_id
terraform output log_analytics_workspace_name
```

## Using Landing Zone Resources in Workloads

Reference the landing zone's networking and monitoring resources in your workload deployments:

```hcl
# Get the VNet for peering or subnet references
data "azurerm_virtual_network" "landing_zone" {
  name                = "acme-vnet-portals-dev-eus-xxxx"
  resource_group_name = "acme-rg-portals-dev-eus-net"
}

# Get the Log Analytics workspace for diagnostics
data "azurerm_log_analytics_workspace" "landing_zone" {
  name                = "acme-log-portals-dev-eus-xxxx"
  resource_group_name = "acme-rg-portals-dev-eus-mon"
}
```

## Policy Compliance

After placing a subscription into a landing zone:
- It inherits policies from the management group
- Some policies may require specific configurations (e.g., allowed locations)
- Review policy assignments in the Azure Portal

## Naming Convention

All resources follow a consistent naming pattern:

```
Pattern: acme-{resource-type}-{landing-zone}-{environment}-{region-abbr}-{role}

Examples:
- acme-rg-mgmt-prod-eus-net         (Management networking RG)
- acme-rg-portals-dev-eus-mon       (Portals monitoring RG)
- acme-vnet-mgmt-prod-eus-jdqy      (Management VNet with unique suffix)
- acme-log-portals-dev-eus-zwtx     (Portals Log Analytics)
```

**Components:**
- `acme` - Organization prefix
- `{resource-type}` - Azure resource type (rg, vnet, log, etc.)
- `{landing-zone}` - Landing zone identifier (mgmt, portals, etc.)
- `{environment}` - Environment (prod, dev, test)
- `{region-abbr}` - Abbreviated region (eus = East US)
- `{role}` - Resource purpose (net = networking, mon = monitoring)
- `{unique}` - Auto-generated 4-character suffix for globally unique names

## Troubleshooting

### Subscription Not Moving
1. Verify Owner or User Access Administrator role on the subscription
2. Check Azure Portal → Management Groups
3. Wait a few minutes for propagation

### Policy Conflicts
1. Check Azure Portal → Policy → Compliance
2. Review Activity Log for denied operations
3. Update workload to comply or adjust policies in foundation

### State Lock Issues
If terraform operations fail due to state locks:
```bash
terraform force-unlock <lock-id>
```

## Best Practices

1. **Separate Landing Zones**: One per workload type or application family
2. **Shared Infrastructure**: Use landing zone VNet and Log Analytics for all related workloads
3. **Consistent Naming**: Follow the established naming convention
4. **Resource Tagging**: Apply consistent tags for cost tracking and governance
5. **Network Planning**: Ensure VNet address spaces don't overlap between landing zones

## Clean Up

To remove a landing zone (⚠️ WARNING: Destroy workloads first):

```bash
# 1. Destroy all workloads using this landing zone
cd ../../03-workloads/portals
terraform destroy

# 2. Then destroy the landing zone infrastructure
cd ../../02-landing-zones/workloads/portals-dev
terraform destroy
```

This will:
- Delete virtual network and subnets
- Delete Log Analytics workspace (❌ logs will be lost)
- Delete resource groups
- Remove subscription from management group

## Additional Resources

- [Azure Landing Zones Documentation](https://learn.microsoft.com/azure/cloud-adoption-framework/ready/landing-zone/)
- [Azure Verified Modules](https://azure.github.io/Azure-Verified-Modules/)
- [Cloud Adoption Framework](https://learn.microsoft.com/azure/cloud-adoption-framework/)
