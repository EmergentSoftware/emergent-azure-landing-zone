# Landing Zone Subscription Placement

This directory contains configurations for placing Azure subscriptions into their respective management groups.

## Structure

```
landing-zones/
├── connectivity/           Platform - Connectivity subscription
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── identity/              Platform - Identity subscription
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── management/            Platform - Management subscription
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars.example
├── workloads/             Workload landing zones
│   └── portals-dev/       Portal dev subscription
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── terraform.tfvars.example
└── README.md              This file
```

## Platform Landing Zones

### Connectivity
- **Management Group**: `acme-connectivity`
- **Subscription ID**: `c82e0943-3765-49ff-97ff-92855167f3ea`
- **Purpose**: Hub networking, VPN/ExpressRoute, firewalls
- **Deployment**: `cd connectivity && terraform apply`

### Identity
- **Management Group**: `acme-identity`
- **Subscription ID**: `05783002-9abe-4167-9270-694d4e9bb733`
- **Purpose**: Domain controllers, AD Connect, identity services
- **Deployment**: `cd identity && terraform apply`

### Management
- **Management Group**: `acme-management`
- **Subscription ID**: `1302f5fd-f3b5-4eda-909c-e3ae2dfee3d6`
- **Purpose**: Monitoring, backup, automation, governance tools
- **Deployment**: `cd management && terraform apply`

## Workload Landing Zones

### Portals Dev
- **Management Group**: `acme-portals`
- **Subscription ID**: `9a877ddf-9796-43a8-a557-f6af1df195bf`
- **Purpose**: Portal application development environment
- **Deployment**: `cd workloads/portals-dev && terraform apply`

## Quick Start

### Platform Subscriptions (Deploy First)

These place platform subscriptions into their respective management groups:

```bash
# Connectivity subscription
cd connectivity
terraform init -backend-config=../../00-bootstrap/backend-config-connectivity.txt
terraform apply

# Identity subscription
cd ../identity
terraform init -backend-config=../../00-bootstrap/backend-config-identity.txt
terraform apply

# Management subscription
cd ../management
terraform init -backend-config=../../00-bootstrap/backend-config-management.txt
terraform apply
```

### Workload Subscriptions (Deploy After Platform)

```bash
# Portal dev subscription
cd workloads/portals-dev
terraform init -backend-config=../../../00-bootstrap/backend-config-portal-dev.txt
terraform apply
```

## What Each Layer Creates

### Platform Landing Zones
Platform landing zones only create the subscription association:
- **Subscription Association**: Links subscription to appropriate management group
  - Inherits policies from ALZ foundation
  - Enables governance and compliance

### Workload Landing Zones
Workload landing zones (like portals-dev) create:



### Monitoring Resources
- **Resource Group**: `rg-{environment}-monitoring-{location}`
- **Log Analytics Workspace**: `log-{environment}-{location}`
  - Configurable retention period (default 30 days)
  - Shared by all workloads in this environment

### Subscription Association
- Links subscription to management group
- Inherits policies from ALZ foundation

## Example: Portal Dev Deployment

```bash
cd workloads/portals-dev
terraform init -backend-config=../../../00-bootstrap/backend-config-portal-dev.txt
terraform apply
```

Get the Log Analytics workspace ID for use in workload deployments:
```bash
terraform output -raw log_analytics_workspace_resource_id
```

## Deployment Order

```
Step 1: 01-foundation/          → Creates management groups & policies
         ↓
Step 2: 02-landing-zones/       → Places subscriptions into management groups (THIS)
         ↓  
Step 3: 03-workloads/           → Deploys application resources
```

## Backend Configuration

Each landing zone uses a separate Terraform state container generated by `00-bootstrap`:

- **connectivity**: `backend-config-connectivity.txt` → `tfstate-connectivity` container
- **identity**: `backend-config-identity.txt` → `tfstate-identity` container
- **management**: `backend-config-management.txt` → `tfstate-management` container
- **portals-dev**: `backend-config-portal-dev.txt` → `tfstate-portal-dev` container

## Verification

After deployment, verify subscriptions are in the correct management groups:

```powershell
# Check connectivity subscription
az account management-group show --name acme-connectivity

# Check identity subscription
az account management-group show --name acme-identity

# Check management subscription
az account management-group show --name acme-management

# Check portals dev subscription
az account management-group show --name acme-portals
```

## Notes

- Platform subscriptions (connectivity, identity, management) only create subscription associations
- Workload subscriptions (portals-dev) also create Log Analytics workspace for monitoring
- All subscription IDs are set as defaults in `variables.tf` files
- Only `tenant_id` needs to be provided in `terraform.tfvars`

### Optional Monitoring Resources
If `create_log_analytics = true`:
- **Resource Group**: `rg-{landing_zone_name}-monitoring-{location}`
- **Log Analytics Workspace**: `log-{landing_zone_name}-{location}`

These can be shared by all workloads in this landing zone.

## Example Scenarios

### Scenario 1: Web Application

```hcl
landing_zone_name                  = "web-apps"
landing_zone_management_group_name = "acme-workloads"
workload_subscription_id           = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

### Scenario 2: API Platform

```hcl
landing_zone_name                  = "public-apis"
landing_zone_management_group_name = "acme-workloads"
workload_subscription_id           = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"
```

## Multiple Landing Zones

To create multiple landing zones, either:

**Option A: Use Workspaces**
```bash
terraform workspace new prod-corp
terraform workspace new prod-online
terraform workspace select prod-corp
terraform apply
```

**Option B: Separate Directories**
```
landing-zones/
├── corp-web-apps/
│   ├── main.tf -> ../main.tf (symlink)
│   └── terraform.tfvars
└── online-apis/
    ├── main.tf -> ../main.tf (symlink)
    └── terraform.tfvars
```

## Outputs

Use these outputs in your workload deployments:

```bash
# Get the Log Analytics workspace ID for workload diagnostics
terraform output -raw log_analytics_workspace_resource_id

# Verify subscription placement
terraform output management_group_id
```

## Connect to Workloads

In your workload's `terraform.tfvars`:

```hcl
# From landing-zones output
log_analytics_workspace_id = "/subscriptions/.../resourceGroups/rg-corp-web-apps-monitoring-eastus/providers/Microsoft.OperationalInsights/workspaces/log-corp-web-apps-eastus"

# Ensure subscription_id matches
subscription_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

## Policy Compliance

After placing a subscription into a landing zone:
- It inherits policies from the management group
- Some policies may require specific configurations (e.g., allowed locations)
- Review policy assignments in the Azure Portal

## Troubleshooting

### Subscription Not Moving

If the subscription doesn't appear under the management group:
1. Verify you have Owner or User Access Administrator role on the subscription
2. Check Azure Portal → Management Groups → Find your subscription
3. Wait a few minutes for Azure Resource Manager to propagate changes

### Policy Conflicts

If workload deployment fails due to policies:
1. Check Azure Portal → Policy → Compliance
2. Review denied operations in Activity Log
3. Either fix the workload to comply, or modify policy assignments in alz-foundation

### Log Analytics Access

If workloads can't write to Log Analytics:
1. Verify the workspace exists: `terraform output log_analytics_workspace_id`
2. Ensure workload's managed identity has Contributor role on workspace
3. Check firewall rules if workspace has network restrictions

## Best Practices

1. **One Landing Zone per Subscription Type**: Separate corp vs online workloads
2. **Shared Monitoring**: Use the landing zone's Log Analytics for all workloads
3. **Consistent Naming**: Use `{org}-landingzones-{type}` pattern
4. **Tag Everything**: Apply consistent tags for cost tracking
5. **Document Dependencies**: Note which workloads depend on this landing zone

## Clean Up

To remove a landing zone (WARNING: This affects all workloads):

```bash
# 1. Destroy all workloads first
cd ../workloads/web-app
terraform destroy

# 2. Then destroy the landing zone
cd ../../landing-zones
terraform destroy
```

This will:
- Remove subscription from management group
- Delete Log Analytics workspace and monitoring resources## Notes

- Platform subscriptions (connectivity, identity, management) only create subscription associations
- Workload subscriptions (portals-dev) also create Log Analytics workspace for monitoring
- All subscription IDs are set as defaults in `variables.tf` files
- Only `tenant_id` needs to be provided in `terraform.tfvars`
