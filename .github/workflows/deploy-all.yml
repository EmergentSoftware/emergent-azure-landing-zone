# ==============================================================================
# Complete Infrastructure Deployment
# ==============================================================================
# Orchestrates deployment of all infrastructure layers:
# - Step 0: Bootstrap (state storage)
# - Step 1: Foundation (management groups, policies)
# - Step 2a-c: Platform landing zones (connectivity, identity, management)
# - Step 3: Workload landing zones (4 environments in parallel)
# - Step 4: Workloads (portal applications)
# Manual trigger only with checkboxes to select which stages to deploy
# ==============================================================================

name: Deploy All Infrastructure

on:
  workflow_dispatch:
    inputs:
      deploy_bootstrap:
        description: 'Deploy Bootstrap (step 0)'
        required: true
        type: boolean
        default: false
      deploy_foundation:
        description: 'Deploy Foundation (step 1)'
        required: true
        type: boolean
        default: true
      deploy_connectivity:
        description: 'Deploy Connectivity (step 2a)'
        required: true
        type: boolean
        default: true
      deploy_identity:
        description: 'Deploy Identity (step 2b)'
        required: true
        type: boolean
        default: true
      deploy_management:
        description: 'Deploy Management (step 2c)'
        required: true
        type: boolean
        default: true
      deploy_workload_lzs:
        description: 'Deploy Workload Landing Zones (step 3)'
        required: true
        type: boolean
        default: true
      deploy_workloads:
        description: 'Deploy Workloads (step 4)'
        required: true
        type: boolean
        default: false
      auto_approve:
        description: 'Auto-approve all deployments (skip manual approval)'
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  # Step 0: Bootstrap
  bootstrap:
    name: '0. Bootstrap'
    runs-on: ubuntu-latest
    if: inputs.deploy_bootstrap
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create terraform.tfvars
        working-directory: 00-bootstrap
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: 00-bootstrap
        env:
          ARM_USE_CLI: true
        run: |
          if [ -f "backend.tfbackend" ]; then
            terraform init -backend-config="backend.tfbackend"
          else
            terraform init
          fi

      - name: Terraform Plan
        working-directory: 00-bootstrap
        env:
          ARM_USE_CLI: true
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: 00-bootstrap
        env:
          ARM_USE_CLI: true
        run: terraform apply -auto-approve tfplan

  # Step 1: Foundation
  foundation:
    name: '1. Foundation'
    runs-on: ubuntu-latest
    needs: bootstrap
    if: |
      always() &&
      (needs.bootstrap.result == 'success' || needs.bootstrap.result == 'skipped') &&
      inputs.deploy_foundation
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create terraform.tfvars
        working-directory: 01-foundation
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: 01-foundation
        env:
          ARM_USE_CLI: true
        run: terraform init -backend-config="backend.tfbackend"

      - name: Terraform Plan
        working-directory: 01-foundation
        env:
          ARM_USE_CLI: true
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: 01-foundation
        env:
          ARM_USE_CLI: true
        run: terraform apply -auto-approve tfplan

  # Step 2a: Connectivity
  connectivity:
    name: '2a. Connectivity'
    runs-on: ubuntu-latest
    needs: foundation
    if: |
      always() &&
      needs.foundation.result == 'success' &&
      inputs.deploy_connectivity
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUB_CONNECTIVITY }}

      - name: Create terraform.tfvars
        working-directory: 02-landing-zones/connectivity
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ secrets.AZURE_SUB_CONNECTIVITY }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: 02-landing-zones/connectivity
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_CONNECTIVITY }}
        run: terraform init -backend-config="backend.tfbackend"

      - name: Terraform Plan
        working-directory: 02-landing-zones/connectivity
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_CONNECTIVITY }}
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: 02-landing-zones/connectivity
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_CONNECTIVITY }}
        run: terraform apply -auto-approve tfplan

  # Step 2b: Identity
  identity:
    name: '2b. Identity'
    runs-on: ubuntu-latest
    needs: foundation
    if: |
      always() &&
      needs.foundation.result == 'success' &&
      inputs.deploy_identity
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUB_IDENTITY }}

      - name: Create terraform.tfvars
        working-directory: 02-landing-zones/identity
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ secrets.AZURE_SUB_IDENTITY }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: 02-landing-zones/identity
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_IDENTITY }}
        run: terraform init -backend-config="backend.tfbackend"

      - name: Terraform Plan
        working-directory: 02-landing-zones/identity
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_IDENTITY }}
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: 02-landing-zones/identity
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_IDENTITY }}
        run: terraform apply -auto-approve tfplan

  # Step 2c: Management
  management:
    name: '2c. Management'
    runs-on: ubuntu-latest
    needs: foundation
    if: |
      always() &&
      needs.foundation.result == 'success' &&
      inputs.deploy_management
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUB_MANAGEMENT }}

      - name: Create terraform.tfvars
        working-directory: 02-landing-zones/management
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ secrets.AZURE_SUB_MANAGEMENT }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: 02-landing-zones/management
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_MANAGEMENT }}
        run: terraform init -backend-config="backend.tfbackend"

      - name: Terraform Plan
        working-directory: 02-landing-zones/management
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_MANAGEMENT }}
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: 02-landing-zones/management
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUB_MANAGEMENT }}
        run: terraform apply -auto-approve tfplan

  # Step 3: Discover Workload Landing Zones
  discover-workload-lzs:
    name: 'Discover Workload LZs'
    runs-on: ubuntu-latest
    needs: [connectivity, identity, management]
    if: |
      always() &&
      needs.connectivity.result == 'success' &&
      needs.identity.result == 'success' &&
      needs.management.result == 'success' &&
      inputs.deploy_workload_lzs
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Discover Workload LZ Directories
        id: set-matrix
        run: |
          # Find all workload LZ directories and extract subscription IDs
          WORKLOAD_LZS='['
          for dir in 02-landing-zones/workloads/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              # Read subscription ID from terraform.tfvars
              if [ -f "${dir}terraform.tfvars" ]; then
                sub_id=$(grep 'subscription_id' "${dir}terraform.tfvars" | cut -d'"' -f2)
                WORKLOAD_LZS+="{\"name\":\"${dirname}\",\"path\":\"${dir%/}\",\"subscription\":\"${sub_id}\"},"
              fi
            fi
          done
          # Remove trailing comma and close array
          WORKLOAD_LZS="${WORKLOAD_LZS%,}]"
          echo "matrix=${WORKLOAD_LZS}" >> $GITHUB_OUTPUT
          echo "Found workload LZs: ${WORKLOAD_LZS}"

  # Step 3: Deploy Workload Landing Zones (parallel)
  workload-lzs:
    name: '3. Workload LZ - ${{ matrix.lz.name }}'
    runs-on: ubuntu-latest
    needs: discover-workload-lzs
    if: needs.discover-workload-lzs.outputs.matrix != '[]'
    strategy:
      matrix:
        lz: ${{ fromJson(needs.discover-workload-lzs.outputs.matrix) }}
      max-parallel: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ matrix.lz.subscription }}

      - name: Create terraform.tfvars
        working-directory: ${{ matrix.lz.path }}
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ matrix.lz.subscription }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: ${{ matrix.lz.path }}
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ matrix.lz.subscription }}
        run: terraform init -backend-config="backend.tfbackend"

      - name: Terraform Plan
        working-directory: ${{ matrix.lz.path }}
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ matrix.lz.subscription }}
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: ${{ matrix.lz.path }}
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ matrix.lz.subscription }}
        run: terraform apply -auto-approve tfplan

  # Step 4: Discover Workloads
  discover-workloads:
    name: 'Discover Workloads'
    runs-on: ubuntu-latest
    needs: workload-lzs
    if: |
      always() &&
      needs.workload-lzs.result == 'success' &&
      inputs.deploy_workloads
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Discover Workload Directories
        id: set-matrix
        run: |
          # Find all workload directories across all workload types
          WORKLOADS='['
          for dir in 03-workloads/*/*/; do
            if [ -d "$dir" ] && [ -f "${dir}terraform.tfvars" ]; then
              dirname=$(basename "$dir")
              # Read subscription ID from terraform.tfvars
              sub_id=$(grep 'subscription_id' "${dir}terraform.tfvars" | cut -d'"' -f2)
              WORKLOADS+="{\"name\":\"${dirname}\",\"path\":\"${dir%/}\",\"subscription\":\"${sub_id}\"},"
            fi
          done
          # Remove trailing comma and close array
          WORKLOADS="${WORKLOADS%,}]"
          echo "matrix=${WORKLOADS}" >> $GITHUB_OUTPUT
          echo "Found workloads: ${WORKLOADS}"

  # Step 4: Deploy Workloads (parallel)
  workloads:
    name: '4. Workload - ${{ matrix.workload.name }}'
    runs-on: ubuntu-latest
    needs: discover-workloads
    if: needs.discover-workloads.outputs.matrix != '[]'
    strategy:
      matrix:
        workload: ${{ fromJson(needs.discover-workloads.outputs.matrix) }}
      max-parallel: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.12.0"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ matrix.workload.subscription }}

      - name: Create terraform.tfvars
        working-directory: ${{ matrix.workload.path }}
        run: |
          cat > terraform.tfvars << EOF
          subscription_id = "${{ matrix.workload.subscription }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        working-directory: ${{ matrix.workload.path }}
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ matrix.workload.subscription }}
        run: terraform init -backend-config="backend.tfbackend"

      - name: Terraform Plan
        working-directory: ${{ matrix.workload.path }}
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ matrix.workload.subscription }}
        run: terraform plan -var-file="terraform.tfvars" -out=tfplan

      - name: Terraform Apply
        if: inputs.auto_approve
        working-directory: ${{ matrix.workload.path }}
        env:
          ARM_USE_CLI: true
          ARM_SUBSCRIPTION_ID: ${{ matrix.workload.subscription }}
        run: terraform apply -auto-approve tfplan

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - bootstrap
      - foundation
      - connectivity
      - identity
      - management
      - workload-lzs
      - workloads
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 0 | Bootstrap | ${{ needs.bootstrap.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Foundation | ${{ needs.foundation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2a | Connectivity | ${{ needs.connectivity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2b | Identity | ${{ needs.identity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2c | Management | ${{ needs.management.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Workload Landing Zones | ${{ needs.workload-lzs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Workloads | ${{ needs.workloads.result }} |" >> $GITHUB_STEP_SUMMARY
